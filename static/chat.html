<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Realtime Chat</title>
    <link rel="icon" href="data:," /> <!-- Suppress favicon.ico requests -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="h-screen flex bg-white">
      <!-- Sidebar (hidden on small screens) -->
      <aside id="sidebar" class="hidden md:flex w-80 border-r p-4 bg-gray-50 flex-col">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold">Chats</h3>
          <button id="btn_refresh_chats_desktop" class="px-2 py-1 bg-gray-200 rounded text-sm">Refresh</button>
        </div>
        
        <div class="my-3">
          <input id="room_input" placeholder="room id or user id" class="w-full border rounded px-3 py-2" />
          <div class="flex gap-2 mt-2">
            <button id="btn_join_room" class="bg-blue-600 text-white px-3 py-1 rounded">Join Room</button>
            <button id="btn_join_dm" class="bg-gray-600 text-white px-3 py-1 rounded">Open DM</button>
          </div>
        </div>

        <div class="my-3">
          <div class="flex items-center justify-between">
            <h4 class="font-medium">All Users</h4>
            <button id="toggle_users_list" class="text-xs px-2 py-1 bg-gray-200 rounded">Hide</button>
          </div>
          <div id="all_users_list" class="mt-2 max-h-40 overflow-y-auto border rounded p-1">
            <!-- all users will be listed here -->
          </div>
        </div>

        <h4 class="font-medium mt-4">Active Room</h4>
        <p id="active_room" class="text-sm text-gray-600">(none)</p>

        <div id="chat_list_container" class="flex-grow overflow-y-auto">
          <!-- Chat list will be rendered here -->
        </div>

        <!-- Logout Button at the bottom -->
        <div class="mt-auto">
          <button id="btn_logout" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">Logout</button>
        </div>
      </aside>

      <!-- Main area -->
      <div class="flex-1 flex flex-col">
        <!-- top bar for mobile -->
        <div class="md:hidden flex items-center justify-between px-3 py-2 border-b bg-white">
          <div class="flex items-center gap-3">
            <button id="btn_toggle_sidebar" class="px-2 py-1 bg-gray-200 rounded">☰</button>
            <div class="text-sm font-medium" id="active_room_mobile">(none)</div>
          </div>
          <div>
            <button id="btn_refresh_chats" class="px-2 py-1 bg-gray-200 rounded">Refresh</button>
          </div>
        </div>

        <div class="flex-1 p-4 flex flex-col overflow-hidden">
          <div class="flex-1 mb-4 overflow-auto" id="messages_container" style="min-height:0;">
            <!-- messages will be appended here -->
          </div>

          <div class="flex gap-2">
            <input id="msg_input" placeholder="Type a message" class="flex-1 border rounded px-3 py-2" />
            <button id="btn_send" class="bg-green-600 text-white px-4 py-2 rounded" disabled>Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
    // --- Configuration ---
    // When running a separate frontend dev server, set the backend URL
    const API_BASE_URL = 'http://localhost:8000' // Set this to your FastAPI backend URL

    // We now rely on server-set cookies for auth (access_token HttpOnly cookie).
    // Socket.IO will send cookies automatically on same-origin connections and the server
    // will read the access_token cookie.
    // For cross-origin, withCredentials must be true for both socket and fetch.
    const socket = io(API_BASE_URL, { withCredentials: true })

    const activeRoomEl = document.getElementById('active_room')
    let activeRoom = null
    let chats = {groups: [], conversations: []}

    // load chats for the user and render sidebar list
    async function loadChats(){
      const res = await fetch(`${API_BASE_URL}/chat/chats`, {credentials: 'include'})
      if(res.status === 401){
        // token missing/expired -> send user to login
        window.location = '/'
        return
      }
      const data = await res.json()
      chats = data
      renderChatList()
    }

    function renderChatList(){
      const container = document.getElementById('chat_list_container');
      container.innerHTML = ''; // Clear previous list
      const list = document.createElement('div');
      list.className = 'mt-4';

      // conversations (DMs)
      const convHeader = document.createElement('h5')
      convHeader.className = 'font-semibold mt-2'
      convHeader.innerText = 'Direct messages'
      list.appendChild(convHeader)
      (chats.conversations || []).forEach(c=>{
        const btn = document.createElement('button')
        btn.className = 'w-full text-left py-1 px-2 rounded hover:bg-gray-200'
  const currentUserId = (document.cookie || '').split(';').map(c=>c.trim()).find(c=>c.startsWith('user_id='))?.split('=')[1]
  const title = c.participant_ids.filter(id=> id !== currentUserId)[0] || c.participant_ids[0]
  // if conversation includes a cached username, prefer it
  const display = c.participant_display_name || title
  // preview and timestamp if available
  let preview = ''
  if(c.last_message && c.last_message.content){
    preview = ' — ' + (c.last_message.content.length > 40 ? c.last_message.content.slice(0,37) + '...' : c.last_message.content)
  }
  const label = `DM: ${display}${preview}`
  btn.innerText = label
        btn.onclick = ()=> openChat(c.room_id)
        list.appendChild(btn)
      })

      // groups
      const grpHeader = document.createElement('h5')
      grpHeader.className = 'font-semibold mt-4'
      grpHeader.innerText = 'Groups'
      list.appendChild(grpHeader)
      (chats.groups || []).forEach(g=>{
        const btn = document.createElement('button')
        btn.className = 'w-full text-left py-1 px-2 rounded hover:bg-gray-200'
        let preview = ''
        if(g.last_message && g.last_message.content){
          preview = ' — ' + (g.last_message.content.length > 40 ? g.last_message.content.slice(0,37) + '...' : g.last_message.content)
        }
        btn.innerText = (g.name || g._id) + preview
        btn.onclick = ()=> openChat('group:'+g._id)
        list.appendChild(btn)
      })

      container.appendChild(list);
    }

    function openChat(room){
      activeRoom = room
      const chat = findChatByRoomId(room);
      let displayName = room; // Default to room ID
      if (chat) {
        if (chat.type === 'dm') {
          const currentUserId = (document.cookie || '').split(';').map(c=>c.trim()).find(c=>c.startsWith('user_id='))?.split('=')[1]
          const isSelfChat = chat.participant_ids.length === 1 || (chat.participant_ids.length === 2 && chat.participant_ids[0] === chat.participant_ids[1]);
          displayName = isSelfChat ? `${chat.participant_display_name} (You)` : chat.participant_display_name;
        } else { // It's a group
          displayName = chat.name;
        }
      }
      activeRoomEl.innerText = displayName;
      // update mobile top label
      const mobileLabel = document.getElementById('active_room_mobile')
      if(mobileLabel) mobileLabel.innerText = displayName;
      // join via socket
      socket.emit('join_room', {room})
      // History is now pre-loaded, find the chat and render its messages
      renderHistoryFromCache(room);
    }

    function findChatByRoomId(roomId) {
      if (roomId.startsWith('group:')) {
        const groupId = roomId.split(':')[1];
        return chats.groups.find(g => g._id === groupId);
      }
      if (roomId.startsWith('dm:')) {
        return chats.conversations.find(c => c.room_id === roomId);
      }
      return null;
    }

    function renderHistoryFromCache(room){
      const chat = findChatByRoomId(room);
      const msgs = chat ? (chat.messages || []) : [];
      const container = document.getElementById('messages_container')
      container.innerHTML = '';
      const currentUser = (document.cookie || '').split(';').map(c=>c.trim()).find(c=>c.startsWith('user_id='))?.split('=')[1]
      (msgs || []).forEach(m=>{
        const el = document.createElement('div')
        el.className = 'mb-2 flex';
        const isMe = (m.sender_id && m.sender_id === currentUser)
        const senderLabel = m.sender_username || ((m.sender_id && m.sender_id === currentUser) ? 'You' : (m.sender_id || 'unknown'))
        // bubble alignment - consistent with socket.on('message')
        const bubbleClass = isMe ? 'ml-auto bg-blue-100 text-right' : 'mr-auto bg-gray-200 text-left'
        el.innerHTML = `<div class="p-2 rounded ${bubbleClass} max-w-[80%]">
          <div class="text-sm text-gray-800">${escapeHtml(m.content || '')}</div>
          <div class="text-xs text-gray-500 mt-1">${senderLabel} • ${formatTimestamp(m.created_at)}</div>
        </div>`
        container.appendChild(el)
      })
      // scroll container to bottom
      container.scrollTop = container.scrollHeight
      // enable send button
      document.getElementById('btn_send').disabled = false
    }

    socket.on('connect', ()=>{
      console.log('connected', socket.id)
    })

    // small helper to avoid injecting raw HTML
    function escapeHtml(unsafe) {
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;")
    }

    function formatTimestamp(iso){
      if (!iso) return '';
      try {
        return new Date(iso).toLocaleString();
      } catch(e) {
        return iso;
      }
    }

  socket.on('message', (payload)=>{
      const m = payload.message || {}
      // only render message if it's for the currently active room
      if (m.chat_id !== activeRoom) return;
      const container = document.getElementById('messages_container')      
      const el = document.createElement('div')
      el.className = 'mb-2 flex';
      const currentUser = (document.cookie || '').split(';').map(c=>c.trim()).find(c=>c.startsWith('user_id='))?.split('=')[1]
      const isMe = (m.sender_id && m.sender_id === currentUser)
      const senderLabel = m.sender_username || ((m.sender_id && m.sender_id === currentUser) ? 'You' : (m.sender_id || 'unknown'))
      const bubbleClass = isMe ? 'ml-auto bg-blue-100 text-right' : 'mr-auto bg-gray-200 text-left'
      el.innerHTML = `<div class="p-2 rounded ${bubbleClass} max-w-[80%]">
        <div class="text-sm text-gray-800">${escapeHtml(m.content || '')}</div>
        <div class="text-xs text-gray-500 mt-1">${senderLabel} • ${formatTimestamp(m.created_at)}</div>
      </div>`
      container.appendChild(el);
      // keep scroll at bottom for new messages
      container.scrollTop = container.scrollHeight
    })

    socket.on('system', (d)=>{
      const container = document.getElementById('messages_container')
      const el = document.createElement('div')
      el.className = 'mb-2 text-xs text-gray-500'
      el.innerText = d.message
      container.prepend(el)
    })

    document.getElementById('btn_join_room').onclick = async ()=>{
      const room = document.getElementById('room_input').value.trim();
      if(!room) {
        console.error('Room ID is empty');
        return;
      }
      console.log(`Attempting to join room: ${room}`); // Debug log
      try {
        await loadChats(); // Refresh sidebar to show new group if it's new for this user
        openChat(room);
      } catch (error) {
        console.error('Failed to join room:', error);
      }
    };

    document.getElementById('btn_join_dm').onclick = async ()=>{
      const other = document.getElementById('room_input').value.trim();
      if(!other) {
        console.error('User ID is empty');
        return;
      }
      console.log(`Attempting to open DM with: ${other}`); // Debug log
      try {
        const res = await fetch(`${API_BASE_URL}/chat/dm/`+encodeURIComponent(other), {method:'POST', credentials:'include'});
        if(res.status === 401){
          window.location = '/';
          return;
        }
        if (!res.ok) {
          throw new Error(`Failed to create DM: ${res.statusText}`);
        }
        const conv = await res.json();
        console.log('DM conversation data:', conv); // Debug log
        const room = conv.room_id || `dm:${other}`;
        await loadChats(); // Refresh sidebar to include the new DM
        openChat(room); // Now open the chat, which will find it in the updated `chats` object
      } catch (error) {
        console.error('Failed to open DM:', error);
      }
    };

    document.getElementById('btn_send').onclick = ()=>{
      const content = document.getElementById('msg_input').value.trim();
      if(!activeRoom) {
        console.error('No active room selected');
        return;
      }
      if(!content) {
        console.error('Message content is empty');
        return;
      }
      console.log(`Sending message to room ${activeRoom}: ${content}`); // Debug log
      try {
        socket.emit('message', {room: activeRoom, content, is_group: activeRoom.startsWith('group:')});
        document.getElementById('msg_input').value = '';
      } catch (error) {
        console.error('Failed to send message:', error);
      }
    };

    // send on enter key
    document.getElementById('msg_input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // prevent new line
        document.getElementById('btn_send').click();
      }
    });

    // --- Logout ---
    document.getElementById('btn_logout').onclick = async () => {
      const res = await fetch(`${API_BASE_URL}/auth/logout`, { method: 'POST', credentials: 'include' });
      if (res.ok) {
        // Redirect to login page on successful logout
        window.location.href = '/index.html';
      }
    };

    // --- User List Toggle ---
    document.getElementById('toggle_users_list').onclick = () => {
      const list = document.getElementById('all_users_list');
      const btn = document.getElementById('toggle_users_list');
      if (list.style.display === 'none') {
        list.style.display = 'block';
        btn.innerText = 'Hide';
      } else {
        list.style.display = 'none';
        btn.innerText = 'Show';
      }
    };

    // --- All Users List ---
    async function loadAllUsers() {
      const res = await fetch(`${API_BASE_URL}/chat/users`, { credentials: 'include' });
      if (!res.ok) return;
      const users = await res.json();
      renderAllUsers(users);
    }

    function renderAllUsers(users) {
      const container = document.getElementById('all_users_list');
      container.innerHTML = '';
      if (!users || users.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500 p-2">No other users found.</p>';
        return;
      }
      const currentUserId = (document.cookie || '').split(';').map(c=>c.trim()).find(c=>c.startsWith('user_id='))?.split('=')[1]
      users.forEach(user => {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left py-1 px-2 rounded hover:bg-gray-200 text-sm';
        const isCurrentUser = user._id === currentUserId;
        btn.innerText = isCurrentUser ? `${user.username} (You)` : user.username;
        btn.onclick = () => {
          // Populate the DM input and click the button to start a chat
          document.getElementById('room_input').value = user._id;
          document.getElementById('btn_join_dm').click();
        };
        container.appendChild(btn);
      });
    }

    // initial load
    loadChats().catch(()=>{})
    loadAllUsers().catch(()=>{})
    </script>
  </body>
 </html>
